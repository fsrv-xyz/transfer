---
stages:
  - build
  - deploy

.config:
  image: docker
  tags:
    - dind

variables:
  IMAGE_NAME: fsrv/${CI_PROJECT_NAME}

build:
  extends: .config
  stage: build
  before_script:
    - apk add curl
    - echo "${REGISTRY_PASSWORD}" | docker login --password-stdin -u "${REGISTRY_USERNAME}"
    - mkdir bin && sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b bin && chmod +x bin/task
  script:
    - bin/task 

rollout:
  stage: deploy
  variables:
    UPDATE_IMAGE_TAG: "${CI_COMMIT_TAG}"
    UPDATE_IMAGE_NAME: "fsrv/transfer"
  trigger:
    project: "fsrvcorp/kubernetes/transfer"
    branch: master
